{% extends "base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div class="admin-header">
    <h1>ğŸ‘‘ Admin Dashboard</h1>
    <p class="admin-subtitle">Manage content, review feedback, and monitor system performance</p>
</div>

<!-- Statistics Overview -->
<div class="admin-stats-grid">
    <div class="stat-card">
        <div class="stat-icon">ğŸ‘¥</div>
        <div class="stat-content">
            <div class="stat-label">Total Users</div>
            <div class="stat-value">{{ user_count }}</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">ğŸ“Š</div>
        <div class="stat-content">
            <div class="stat-label">Quizzes Generated</div>
            <div class="stat-value">{{ quiz_count }}</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">ğŸ’¬</div>
        <div class="stat-content">
            <div class="stat-label">Pending Feedback</div>
            <div class="stat-value">{{ feedback_items|length }}</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">ğŸš©</div>
        <div class="stat-content">
            <div class="stat-label">Flagged Questions</div>
            <div class="stat-value">{{ flagged_count }}</div>
        </div>
    </div>
</div>

<!-- Admin Navigation Tabs -->
<div class="admin-tabs">
    <button class="tab-btn active" onclick="showTab('feedback')">ğŸ“ Question Feedback</button>
    <button class="tab-btn" onclick="showTab('content')">ğŸ“š Content Management</button>
    <button class="tab-btn" onclick="showTab('users')">ğŸ‘¥ User Management</button>
    <button class="tab-btn" onclick="showTab('analytics')">ğŸ“ˆ Analytics</button>
</div>

<!-- Feedback Tab -->
<div id="feedback-tab" class="tab-content active">
    <div class="card">
        <div class="card-header">
            <h2>ğŸš© Question Feedback & Flagged Content</h2>
            <div class="card-actions">
                <button class="btn btn-primary" onclick="refreshFeedback()">ğŸ”„ Refresh</button>
                <button class="btn btn-success" onclick="markAllResolved()">âœ… Mark All Resolved</button>
            </div>
        </div>
        
        {% if feedback_items %}
            <div class="feedback-list">
                {% for item in feedback_items %}
                <div class="feedback-item {% if item.is_flagged %}flagged{% endif %}">
                    <div class="feedback-header">
                        <div class="feedback-meta">
                            <span class="user-info">ğŸ‘¤ User #{{ item.user_id }}</span>
                            <span class="date-info">ğŸ“… {{ item.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                            {% if item.is_flagged %}
                                <span class="flagged-badge">ğŸš© FLAGGED</span>
                            {% endif %}
                        </div>
                        <div class="feedback-actions">
                            <button class="btn btn-sm btn-success" onclick="resolveFeedback({{ item.id }})">âœ… Resolve</button>
                            <button class="btn btn-sm btn-info" onclick="viewDetails({{ item.id }})">ğŸ‘ï¸ Details</button>
                        </div>
                    </div>
                    
                    <div class="feedback-content">
                        <div class="question-section">
                            <h4>ğŸ“ Question:</h4>
                            <div class="question-text">{{ item.question_text }}</div>
                        </div>
                        
                        <div class="feedback-section">
                            <h4>ğŸ’¬ Feedback:</h4>
                            <div class="feedback-text">{{ item.feedback_text }}</div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <div class="empty-icon">ğŸ‰</div>
                <h3>No Pending Feedback</h3>
                <p>Great job! All feedback has been reviewed.</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Content Management Tab -->
<div id="content-tab" class="tab-content">
    <div class="card">
        <div class="card-header">
            <h2>ğŸ“š Content Management</h2>
            <div class="card-actions">
                <button class="btn btn-primary" onclick="uploadContent()">ğŸ“¤ Upload Content</button>
                <button class="btn btn-secondary" onclick="manageMaterials()">ğŸ“‹ Manage Materials</button>
            </div>
        </div>
        
        <div class="content-stats">
            <div class="content-stat">
                <h4>ğŸ“„ Total Materials</h4>
                <span class="stat-number">{{ material_count }}</span>
            </div>
            <div class="content-stat">
                <h4>ğŸ“Š Total Questions</h4>
                <span class="stat-number">{{ question_count }}</span>
            </div>
        </div>
        
        <div class="recent-materials">
            <h3>ğŸ“‹ Recent Materials</h3>
            <div class="materials-list">
                {% for material in recent_materials %}
                <div class="material-item">
                    <div class="material-info">
                        <h4>{{ material.title }}</h4>
                        <p>{{ material.content[:100] }}...</p>
                        <small>Type: {{ material.material_type }} | Uploaded: {{ material.created_at.strftime('%Y-%m-%d') }}</small>
                    </div>
                    <div class="material-actions">
                        <button class="btn btn-sm btn-info" onclick="viewMaterial({{ material.id }})">ğŸ‘ï¸ View</button>
                        <button class="btn btn-sm btn-warning" onclick="editMaterial({{ material.id }})">âœï¸ Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteMaterial({{ material.id }})">ğŸ—‘ï¸ Delete</button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- User Management Tab -->
<div id="users-tab" class="tab-content">
    <div class="card">
        <div class="card-header">
            <h2>ğŸ‘¥ User Management</h2>
            <div class="card-actions">
                <button class="btn btn-primary" onclick="exportUsers()">ğŸ“Š Export Users</button>
                <button class="btn btn-secondary" onclick="viewUserStats()">ğŸ“ˆ User Stats</button>
            </div>
        </div>
        
        <div class="user-stats">
            <div class="user-stat">
                <h4>ğŸ‘¤ Active Users</h4>
                <span class="stat-number">{{ active_users }}</span>
            </div>
            <div class="user-stat">
                <h4>ğŸ“Š Total Quizzes</h4>
                <span class="stat-number">{{ total_quizzes }}</span>
            </div>
            <div class="user-stat">
                <h4>â­ Average Score</h4>
                <span class="stat-number">{{ avg_score }}%</span>
            </div>
        </div>
        
        <div class="recent-users">
            <h3>ğŸ‘¥ Recent Users</h3>
            <div class="users-list">
                {% for user in recent_users %}
                <div class="user-item">
                    <div class="user-info">
                        <h4>{{ user.username }}</h4>
                        <p>{{ user.email }}</p>
                        <small>Joined: {{ user.created_at.strftime('%Y-%m-%d') }}</small>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-sm btn-info" onclick="viewUser({{ user.id }})">ğŸ‘ï¸ View</button>
                        <button class="btn btn-sm btn-warning" onclick="editUser({{ user.id }})">âœï¸ Edit</button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Analytics Tab -->
<div id="analytics-tab" class="tab-content">
    <div class="card">
        <div class="card-header">
            <h2>ğŸ“ˆ System Analytics</h2>
            <div class="card-actions">
                <button class="btn btn-primary" onclick="exportAnalytics()">ğŸ“Š Export Data</button>
                <button class="btn btn-secondary" onclick="refreshAnalytics()">ğŸ”„ Refresh</button>
            </div>
        </div>
        
        <div class="analytics-grid">
            <div class="analytics-chart">
                <h3>ğŸ“Š Quiz Performance Over Time</h3>
                <canvas id="quiz-performance-chart"></canvas>
            </div>
            <div class="analytics-chart">
                <h3>ğŸ‘¥ User Growth</h3>
                <canvas id="user-growth-chart"></canvas>
            </div>
        </div>
        
        <div class="analytics-summary">
            <h3>ğŸ“‹ Quick Stats</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-label">Most Popular Subject:</span>
                    <span class="stat-value">{{ popular_subject }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Average Quiz Duration:</span>
                    <span class="stat-value">{{ avg_duration }} min</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">System Uptime:</span>
                    <span class="stat-value">{{ uptime }}%</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Feedback Details Modal -->
<div id="feedback-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ“ Feedback Details</h3>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body" id="feedback-details">
            <!-- Dynamic content will be loaded here -->
        </div>
        <div class="modal-footer">
            <button class="btn btn-success" onclick="resolveFromModal()">âœ… Resolve</button>
            <button class="btn btn-secondary" onclick="closeModal()">âŒ Close</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Tab Management
function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabName + '-tab').classList.add('active');
    
    // Add active class to clicked button
    event.target.classList.add('active');
}

// Feedback Management
function resolveFeedback(feedbackId) {
    if (confirm('Are you sure you want to resolve this feedback?')) {
        fetch(`/admin/resolve-feedback/${feedbackId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error resolving feedback: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while resolving feedback.');
        });
    }
}

function markAllResolved() {
    if (confirm('Are you sure you want to mark ALL feedback as resolved?')) {
        fetch('/admin/resolve-all-feedback', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred.');
        });
    }
}

function refreshFeedback() {
    location.reload();
}

function viewDetails(feedbackId) {
    // Load feedback details into modal
    fetch(`/admin/feedback-details/${feedbackId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('feedback-details').innerHTML = `
                <div class="feedback-detail">
                    <h4>Question:</h4>
                    <p>${data.question_text}</p>
                    <h4>Feedback:</h4>
                    <p>${data.feedback_text}</p>
                    <h4>User Info:</h4>
                    <p>User ID: ${data.user_id}</p>
                    <p>Date: ${data.created_at}</p>
                    <p>Flagged: ${data.is_flagged ? 'Yes' : 'No'}</p>
                </div>
            `;
            document.getElementById('feedback-modal').style.display = 'block';
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading feedback details.');
        });
}

// Modal Management
function closeModal() {
    document.getElementById('feedback-modal').style.display = 'none';
}

function resolveFromModal() {
    const feedbackId = document.querySelector('.feedback-detail').dataset.feedbackId;
    resolveFeedback(feedbackId);
    closeModal();
}

// Content Management Functions
function uploadContent() {
    window.location.href = '/upload-material';
}

function manageMaterials() {
    window.location.href = '/list-materials';
}

function viewMaterial(materialId) {
    window.location.href = `/view-material/${materialId}`;
}

function editMaterial(materialId) {
    // Implement edit functionality
    alert('Edit material functionality coming soon!');
}

function deleteMaterial(materialId) {
    if (confirm('Are you sure you want to delete this material?')) {
        fetch(`/admin/delete-material/${materialId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting material: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the material.');
        });
    }
}

// User Management Functions
function exportUsers() {
    window.location.href = '/admin/export-users';
}

function viewUserStats() {
    alert('User statistics functionality coming soon!');
}

function viewUser(userId) {
    window.location.href = `/admin/user/${userId}`;
}

function editUser(userId) {
    alert('Edit user functionality coming soon!');
}

// Analytics Functions
function exportAnalytics() {
    window.location.href = '/admin/export-analytics';
}

function refreshAnalytics() {
    location.reload();
}

// Initialize charts when analytics tab is shown
document.addEventListener('DOMContentLoaded', function() {
    // Chart initialization will be added here
    console.log('Admin dashboard loaded');
});
</script>
{% endblock %}
